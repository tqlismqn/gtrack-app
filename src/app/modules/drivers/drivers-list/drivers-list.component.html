<div class="drivers-container">
  <!-- Page Header -->
  <div class="page-header">
    <div>
      <h1 class="h1">Drivers</h1>
      <p class="page-subtitle">Manage driver documents and status • {{ stats().total }} total</p>
    </div>
    <div class="header-actions">
      <button mat-stroked-button color="primary" (click)="testApi()">
        <mat-icon>bug_report</mat-icon>
        Test API
      </button>
      <button mat-raised-button color="primary" class="btn-primary" disabled>
        <mat-icon>add</mat-icon>
        Add Driver
      </button>
    </div>
  </div>

  <!-- Stats Cards -->
  <div class="stats-grid">
    <div class="stat-card">
      <div class="stat-icon primary">
        <mat-icon>people</mat-icon>
      </div>
      <div class="stat-content">
        <div class="stat-label">Total Drivers</div>
        <div class="stat-value">{{ stats().total }}</div>
      </div>
    </div>

    <div class="stat-card">
      <div class="stat-icon success">
        <mat-icon>check_circle</mat-icon>
      </div>
      <div class="stat-content">
        <div class="stat-label">Active</div>
        <div class="stat-value">{{ stats().active }}</div>
      </div>
    </div>

    <div class="stat-card">
      <div class="stat-icon warning">
        <mat-icon>schedule</mat-icon>
      </div>
      <div class="stat-content">
        <div class="stat-label">On Leave</div>
        <div class="stat-value">{{ stats().onLeave }}</div>
      </div>
    </div>

    <div class="stat-card">
      <div class="stat-icon success-light">
        <mat-icon>verified</mat-icon>
      </div>
      <div class="stat-content">
        <div class="stat-label">Documents OK</div>
        <div class="stat-value">{{ stats().documentsValid }}</div>
      </div>
    </div>

    <div class="stat-card">
      <div class="stat-icon error">
        <mat-icon>warning</mat-icon>
      </div>
      <div class="stat-content">
        <div class="stat-label">Issues</div>
        <div class="stat-value">{{ stats().documentsExpired }}</div>
      </div>
    </div>
  </div>

  <!-- Filters & Search -->
  <div class="filters-section">
    <div class="search-box">
      <mat-icon>search</mat-icon>
      <input
        type="text"
        placeholder="Search by name, email, or phone..."
        [(ngModel)]="searchModel"
        (input)="onSearch()"
      />
    </div>

    <div class="filter-chips">
      <button
        mat-stroked-button
        [class.active]="selectedStatusFilter() === 'all'"
        (click)="filterByStatus('all')"
      >
        All
      </button>
      <button
        mat-stroked-button
        [class.active]="selectedStatusFilter() === 'valid'"
        (click)="filterByStatus('valid')"
        class="chip-valid"
      >
        <span class="status-dot valid"></span>
        Valid
      </button>
      <button
        mat-stroked-button
        [class.active]="selectedStatusFilter() === 'expiring'"
        (click)="filterByStatus('expiring')"
        class="chip-expiring"
      >
        <span class="status-dot expiring"></span>
        Expiring ≤30d
      </button>
      <button
        mat-stroked-button
        [class.active]="selectedStatusFilter() === 'expired'"
        (click)="filterByStatus('expired')"
        class="chip-expired"
      >
        <span class="status-dot expired"></span>
        Expired
      </button>
    </div>
  </div>

  <!-- Loading State -->
  @if (loading()) {
    <div class="loading-state">
      <mat-progress-spinner diameter="36" mode="indeterminate"></mat-progress-spinner>
      <p>Loading drivers...</p>
    </div>
  }

  <!-- Error State -->
  @if (error()) {
    <div class="error-state">
      <mat-icon>error_outline</mat-icon>
      <p>{{ error() }}</p>
      <button mat-button color="primary" (click)="loadDrivers()">Retry</button>
    </div>
  }

  <!-- Drivers Table -->
  @if (!loading() && !error()) {
    <div class="table-container">
      <table class="drivers-table">
        <thead>
          <tr>
            <th>Name</th>
            <th>ID</th>
            <th>Citizenship</th>
            <th>Status</th>
            <th>Documents</th>
            <th class="text-center">≤30d</th>
            <th class="text-right">Actions</th>
          </tr>
        </thead>
        <tbody>
          @for (driver of paginatedDrivers(); track driver.id) {
            <tr
              class="table-row"
              [class.selected]="selectedDriver()?.id === driver.id"
              (click)="selectDriver(driver)"
            >
              <td>
                <div class="driver-info">
                  <div class="driver-avatar">{{ getInitials(driver) }}</div>
                  <div>
                    <div class="driver-name">{{ getFullName(driver) }}</div>
                    <div class="driver-email">{{ driver.email }}</div>
                  </div>
                </div>
              </td>
              <td>
                <span class="text-secondary">{{ driver.rodne_cislo || '—' }}</span>
              </td>
              <td>
                <span class="citizenship-badge">{{ driver.citizenship }}</span>
              </td>
              <td>
                <span
                  class="status-badge"
                  [class.status-active]="driver.status === 'active'"
                  [class.status-leave]="driver.status === 'on_leave'"
                  [class.status-inactive]="driver.status === 'inactive' || driver.status === 'terminated'"
                >
                  {{ getStatusLabel(driver.status) }}
                </span>
              </td>
              <td>
                <div class="document-indicators">
                  @for (status of getDocumentStatuses(driver); track $index) {
                    <span
                      class="doc-indicator"
                      [class.doc-valid]="status === 'valid'"
                      [class.doc-warning]="status === 'warning'"
                      [class.doc-expiring]="status === 'expiring_soon'"
                      [class.doc-expired]="status === 'expired'"
                      [class.doc-empty]="status === 'no_data'"
                      [matTooltip]="getDocumentTooltip(status)"
                    ></span>
                  }
                </div>
              </td>
              <td class="text-center">
                @if (getExpiringCount(driver) > 0) {
                  <span class="expiring-badge">{{ getExpiringCount(driver) }}</span>
                } @else {
                  <span class="text-tertiary">—</span>
                }
              </td>
              <td class="text-right">
                <button
                  mat-icon-button
                  [matMenuTriggerFor]="driverActions"
                  (click)="$event.stopPropagation()"
                >
                  <mat-icon>more_vert</mat-icon>
                </button>
                <mat-menu #driverActions="matMenu">
                  <button mat-menu-item (click)="selectDriver(driver)">
                    <mat-icon>visibility</mat-icon>
                    View Details
                  </button>
                  <button mat-menu-item disabled>
                    <mat-icon>edit</mat-icon>
                    Edit
                  </button>
                  <button mat-menu-item disabled>
                    <mat-icon>upload_file</mat-icon>
                    Upload Document
                  </button>
                </mat-menu>
              </td>
            </tr>
          }
        </tbody>
      </table>

      <!-- Empty State -->
      @if (filteredDrivers().length === 0) {
        <div class="empty-state">
          <mat-icon>people_outline</mat-icon>
          <h3>No drivers found</h3>
          <p>Try adjusting your search or filters</p>
        </div>
      }
    </div>
  }

  <!-- Pagination -->
  @if (!loading() && !error() && filteredDrivers().length > 0) {
    <div class="pagination">
      <div class="pagination-info">
        Showing {{ pageStart }} to
        {{ pageEnd }} of
        {{ filteredDrivers().length }} drivers
      </div>
      <div class="pagination-controls">
        <button mat-icon-button [disabled]="currentPage() === 1" (click)="previousPage()">
          <mat-icon>chevron_left</mat-icon>
        </button>
        <span class="page-number">{{ currentPage() }}</span>
        <button
          mat-icon-button
          [disabled]="currentPage() * pageSize() >= filteredDrivers().length"
          (click)="nextPage()"
        >
          <mat-icon>chevron_right</mat-icon>
        </button>
      </div>
    </div>
  }

  <!-- Driver Details -->
  @if (selectedDriver()) {
    <div class="driver-details-card">
      <div class="details-header">
        <div class="details-avatar">{{ getInitials(selectedDriver()!) }}</div>
        <div>
          <h2 class="details-name">{{ getFullName(selectedDriver()!) }}</h2>
          <p class="details-subtitle">Driver #{{ selectedDriver()!.internal_number }}</p>
        </div>
      </div>

      <div class="details-grid">
        <div class="detail-group">
          <h3>Personal</h3>
          <div class="detail-item">
            <span class="label">Email</span>
            <span class="value">{{ selectedDriver()!.email }}</span>
          </div>
          <div class="detail-item">
            <span class="label">Phone</span>
            <span class="value">{{ selectedDriver()!.phone || '—' }}</span>
          </div>
          <div class="detail-item">
            <span class="label">Birth Date</span>
            <span class="value">{{ selectedDriver()!.birth_date | date }}</span>
          </div>
          <div class="detail-item">
            <span class="label">Citizenship</span>
            <span class="value">{{ selectedDriver()!.citizenship }}</span>
          </div>
        </div>

        <div class="detail-group">
          <h3>Employment</h3>
          <div class="detail-item">
            <span class="label">Status</span>
            <span class="value">{{ getStatusLabel(selectedDriver()!.status) }}</span>
          </div>
          <div class="detail-item">
            <span class="label">Location</span>
            <span class="value">{{ selectedDriver()!.work_location | titlecase }}</span>
          </div>
          <div class="detail-item">
            <span class="label">Hire Date</span>
            <span class="value">{{ selectedDriver()!.hire_date | date }}</span>
          </div>
          <div class="detail-item">
            <span class="label">Contract</span>
            <span class="value">
              {{ selectedDriver()!.contract_indefinite ? 'Indefinite' : 'Fixed Term' }}
            </span>
          </div>
        </div>

        <div class="detail-group">
          <h3>Documents</h3>
          @if (selectedDriverDocuments.length > 0) {
            <div class="documents-list">
              @for (doc of selectedDriverDocuments; track doc.id) {
                <div class="document-item">
                  <div class="document-status" [ngClass]="{
                    'status-valid': doc.status === 'valid',
                    'status-warning': doc.status === 'warning' || doc.status === 'expiring_soon',
                    'status-expired': doc.status === 'expired',
                    'status-empty': doc.status === 'no_data'
                  }"></div>
                  <div>
                    <div class="document-name">{{ getDocumentLabel(doc.type) }}</div>
                    <div class="document-meta">
                      @if (doc.to) {
                        <span>Expires {{ doc.to | date }}</span>
                      }
                      @if (doc.number) {
                        <span>• № {{ doc.number }}</span>
                      }
                    </div>
                  </div>
                </div>
              }
            </div>
          } @else {
            <p class="empty-documents">No documents available</p>
          }
        </div>
      </div>

      <div class="details-actions">
        <button mat-stroked-button color="primary" disabled>
          <mat-icon>edit</mat-icon>
          Edit
        </button>
        <button mat-stroked-button disabled>
          <mat-icon>upload_file</mat-icon>
          Upload Documents
        </button>
      </div>
    </div>
  }
</div>
